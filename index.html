<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Long Entropy Capital</title>
    <link rel="icon" href="favicon.png">
    <meta name="description" content="Long Entropy Capital ‚Äî AUM and Portfolio Breakdown" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      (function() {
        const storageKey = 'lec-theme';
        const docEl = document.documentElement;
        let theme = docEl.dataset.theme || 'dark';
        try {
          const stored = localStorage.getItem(storageKey);
          if (stored === 'light' || stored === 'dark') {
            theme = stored;
          } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            theme = 'dark';
          } else {
            theme = 'light';
          }
        } catch (err) {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            theme = 'dark';
          } else {
            theme = 'light';
          }
        }
        docEl.dataset.theme = theme;
        docEl.style.colorScheme = theme;
      })();
    </script>
    <style>
      :root {
        color-scheme: dark;
        --base-bg: #0f1010;
        --body-bg: #181a1b;
        --text-base: #f7f8f8;
        --text-alt: #dfe1e2;
        --accent: #ff9900; /* Bitcoin orange */
        --ring: rgba(255,153,0,0.25);
        --chip-bg: rgba(255,153,0,0.14);
        --chip-border: rgba(255,153,0,0.25);
        --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        --card-border: rgba(255,255,255,0.06);
        --card-shadow: 0 12px 30px rgba(0,0,0,0.30);
        --hover-bg: rgba(255,255,255,0.02);
        --table-border: rgba(255,255,255,0.08);
        --table-row-border: rgba(255,255,255,0.06);
        --legend-color: #e6e6f0;
        --bg-gradient: radial-gradient(1200px 800px at 20% -10%, #191923, transparent 60%), var(--base-bg);
      }
      :root[data-theme="light"] {
        color-scheme: light;
        --base-bg: #f7f8f8;
        --body-bg: #ffffff;
        --text-base: #181a1b;
        --text-alt: #3d4143;
        --card-bg: linear-gradient(180deg, rgba(15,16,16,0.03), rgba(15,16,16,0.01));
        --card-border: rgba(24,26,27,0.08);
        --card-shadow: 0 12px 24px rgba(15,16,16,0.08);
        --hover-bg: rgba(15,16,16,0.04);
        --table-border: rgba(24,26,27,0.12);
        --table-row-border: rgba(24,26,27,0.08);
        --chip-bg: rgba(255,153,0,0.12);
        --chip-border: rgba(255,153,0,0.24);
        --legend-color: #3d4143;
        --bg-gradient: radial-gradient(1200px 800px at 20% -10%, rgba(255,255,255,0.7), transparent 60%), var(--base-bg);
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg-gradient);
        background-color: var(--base-bg);
        color: var(--text-base);
        -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      a { color: var(--text-base); text-decoration: none; transition: color 0.2s ease; }
      a:hover { color: var(--accent); }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 20px 80px; }
      header { display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap; }
      .identity { display: flex; align-items: center; gap: 16px; min-width: 0; }
      header img.logo { height: 56px; width: auto; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.35)); }
      header .brand { display: flex; flex-direction: column; }
      header h1 { margin: 0; font-size: clamp(26px, 4vw, 36px); letter-spacing: 0.3px; }
      header p.tag { margin: 2px 0 0; color: var(--text-alt); font-size: 14px; }
      .theme-toggle {
        border: 1px solid var(--card-border);
        background: var(--body-bg);
        color: var(--text-base);
        font-size: 13px;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
        margin-left: auto;
      }
      .theme-toggle:focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px var(--ring);
      }
      .theme-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--ring);
      }

      .grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 28px; }
      @media (min-width: 900px) { .grid { grid-template-columns: 420px 1fr; } }

      .card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 18px; padding: 18px; box-shadow: var(--card-shadow); transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; }
      .card h2 { margin: 2px 0 8px; font-size: 18px; color: var(--text-base); }
      .card .sub { color: var(--text-alt); font-size: 13px; margin-bottom: 10px; }

      .aum { display: grid; gap: 8px; }
      .aum .value { font-size: clamp(36px, 6vw, 56px); font-weight: 800; letter-spacing: -0.5px; }
      .aum .updated { color: var(--text-alt); font-size: 13px; }

      .pie-wrap { position: relative; min-height: 360px; }
      canvas { width: 100% !important; height: 360px !important; }

      table { width: 100%; border-collapse: collapse; font-size: 14px; }
      thead th { text-align: left; color: var(--text-alt); font-weight: 600; border-bottom: 1px solid var(--table-border); padding: 10px 8px; }
      tbody td { padding: 10px 8px; border-bottom: 1px dashed var(--table-row-border); }
      tbody tr:hover { background: var(--hover-bg); }
      .right { text-align: right; }
      .chip { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: var(--chip-bg); color: var(--accent); border: 1px solid var(--chip-border); }

      footer { margin-top: 36px; color: var(--text-alt); font-size: 14px; display: flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
      .email { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid var(--card-border); border-radius: 999px; background: var(--hover-bg); transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; }
      .email:hover { border-color: var(--ring); box-shadow: 0 0 0 6px var(--ring) inset; background: var(--body-bg); }

      .hint { font-size: 12px; color: var(--text-alt); }
      .err { color: #fba6a6; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="identity">
          <!-- Place your logo file named 'satssymbol.png' in the same folder as this index.html -->
          <img class="logo" src="satssymbol.png" alt="Long Entropy Capital logo" />
          <div class="brand">
            <h1>Long Entropy Capital</h1>
            <p class="tag">Digital Capital √ó Digital Intelligence</p>
          </div>
        </div>
        <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="true" aria-label="Toggle color theme" title="Switch to light mode">‚òÄÔ∏è Light</button>
      </header>

      <div class="grid">
        <section class="card">
          <h2>Assets Under Management</h2>
          <div class="sub">Sourced live from Google&nbsp;Sheets <span id="sheetState" class="chip">Loading‚Ä¶</span></div>
          <div class="aum">
            <div id="aumValue" class="value">‚Äî</div>
            <div class="updated">Last updated: <span id="lastUpdated">‚Äî</span></div>
            <div id="aumError" class="hint err" hidden></div>
            <div class="hint">Tip: ensure your Sheet is set to <em>Anyone with the link can view</em> or <em>File ‚Üí Share ‚Üí Publish to web</em>.</div>
          </div>
        </section>

        <section class="card">
          <h2>Portfolio Allocation</h2>
          <div class="sub">Breakdown adds to 100%</div>
          <div class="pie-wrap"><canvas id="pie"></canvas></div>
        </section>
      </div>

      <section class="card" style="margin-top:20px">
        <h2>Positions</h2>
        <table>
          <thead>
            <tr><th>Position</th><th class="right">Weight</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>

      <footer>
        <div>
          <a class="email" href="mailto:hello@longentropycapital.com" aria-label="Email Long Entropy Capital">
            <!-- Simple envelope icon -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5h18v14H3z" stroke="currentColor" stroke-width="1.5"/><path d="m3 7 9 7 9-7" stroke="currentColor" stroke-width="1.5"/></svg>
            hello@longentropycapital.com
          </a>
        </div>
        <div class="hint">¬© <span id="year"></span> Long Entropy Capital</div>
      </footer>
    </div>

    <script>
      const themeToggle = document.getElementById('themeToggle');
      const THEME_STORAGE_KEY = 'lec-theme';

      function readStoredTheme() {
        try { return localStorage.getItem(THEME_STORAGE_KEY); } catch { return null; }
      }

      function writeStoredTheme(theme) {
        try { localStorage.setItem(THEME_STORAGE_KEY, theme); } catch {}
      }

      function getLegendColor() {
        const styles = getComputedStyle(document.documentElement);
        return (styles.getPropertyValue('--legend-color').trim() || styles.getPropertyValue('--text-alt').trim() || styles.getPropertyValue('--text-base').trim() || '#666');
      }

      function applyTheme(theme, persist = true) {
        const nextTheme = theme === 'light' ? 'light' : 'dark';
        document.documentElement.dataset.theme = nextTheme;
        document.documentElement.style.colorScheme = nextTheme;
        if (persist) writeStoredTheme(nextTheme);
        if (themeToggle) {
          const isDark = nextTheme === 'dark';
          themeToggle.setAttribute('aria-pressed', String(isDark));
          themeToggle.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
          const label = isDark ? 'Switch to light mode' : 'Switch to dark mode';
          themeToggle.title = label;
          themeToggle.setAttribute('aria-label', label);
        }
        if (window._pie) {
          const legendColor = getLegendColor();
          if (
            legendColor &&
            window._pie.options &&
            window._pie.options.plugins &&
            window._pie.options.plugins.legend &&
            window._pie.options.plugins.legend.labels
          ) {
            window._pie.options.plugins.legend.labels.color = legendColor;
          }
          window._pie.update();
        }
      }

      function initTheme() {
        const storedTheme = readStoredTheme();
        const mediaQuery = typeof window.matchMedia === 'function'
          ? window.matchMedia('(prefers-color-scheme: dark)')
          : null;
        const current = document.documentElement.dataset.theme;
        const fallback = mediaQuery && mediaQuery.matches ? 'dark' : 'light';
        applyTheme(storedTheme || current || fallback, false);
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            const next = document.documentElement.dataset.theme === 'light' ? 'dark' : 'light';
            applyTheme(next);
          });
        }
        const handleSchemeChange = (event) => {
          if (readStoredTheme()) return;
          applyTheme(event.matches ? 'dark' : 'light', false);
        };
        if (mediaQuery) {
          try {
            mediaQuery.addEventListener('change', handleSchemeChange);
          } catch (err) {
            if (typeof mediaQuery.addListener === 'function') {
              mediaQuery.addListener(handleSchemeChange);
            }
          }
        }
      }

      initTheme();

      // ========================
      //  CONFIG ‚Äî update as needed
      // ========================
      const CONFIG = {
        sheetId: '1tDWV-I1m1CRoU00UNoVOLKlO94n2nKgFfAQ2snicRAU',
        sheetName: 'Dashboard',
        // AUM: provide a single-cell range like 'B2:B2' (value expected as number). Update to match your Dashboard.
        aumRange: 'L2:L2',
        // last updated date (optional). If you track a latest NAV date on the dashboard, point to that cell; otherwise we use today.
        lastUpdatedRange: 'B3:B3',
        // Portfolio table range with two columns: [Label, Weight].
        // Weight can be 0-1 (decimal) or 0-100 (percent); set weightIsPercent accordingly.
        portfolioRange: 'N16:O50',
        weightIsPercent: true,
      };

      // ========================
      //  UTILITIES
      // ========================
      const fmtUSD0 = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
      const fmtPct = new Intl.NumberFormat('en-US', { style: 'percent', maximumFractionDigits: 1 });

      function csvParse(text) {
        // Tiny CSV parser that handles quotes and commas
        const rows = []; let row = []; let cur = '';
        let i = 0, q = false;
        while (i < text.length) {
          const c = text[i];
          if (c === '"') {
            if (q && text[i+1] === '"') { cur += '"'; i++; }
            else { q = !q; }
          } else if (c === ',' && !q) { row.push(cur); cur=''; }
          else if ((c === '\n' || c === '\r') && !q) {
            if (cur !== '' || row.length) { row.push(cur); rows.push(row); row = []; cur=''; }
          } else { cur += c; }
          i++;
        }
        if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
        return rows.filter(r => r.length && !r.every(x => x === ''));
      }

      async function fetchCSV(range) {
        const u = new URL(`https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq`);
        u.searchParams.set('tqx','out:csv');
        u.searchParams.set('sheet', CONFIG.sheetName);
        if (range) u.searchParams.set('range', range);
        const res = await fetch(u, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        return csvParse(txt);
      }

      function normalizeWeights(pairs) {
        let rows = pairs.filter(r => r[0] && r[1] !== undefined && r[1] !== '');
        let mapped = rows.map(([name, w]) => {
          let num = parseFloat(String(w).replace(/[%,$\s]/g,''));
          if (Number.isNaN(num)) return null;
          if (!CONFIG.weightIsPercent) num *= 100; // convert decimal ‚Üí percent
          return { name: String(name).trim(), weight: num };
        }).filter(Boolean);
        const sum = mapped.reduce((a, r) => a + r.weight, 0);
        if (sum <= 0) return mapped;
        // Normalize softly to 100 while preserving proportions
        return mapped.map(r => ({ ...r, weight: r.weight * (100 / sum) }));
      }

      function renderTable(rows) {
        const tb = document.getElementById('rows');
        tb.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const tdA = document.createElement('td');
          const tdB = document.createElement('td');
          tdA.textContent = r.name;
          tdB.textContent = fmtPct.format(r.weight / 100);
          tdB.className = 'right';
          tr.append(tdA, tdB);
          tb.appendChild(tr);
        });
      }

      function renderPie(rows) {
        const ctx = document.getElementById('pie');
        if (window._pie) window._pie.destroy();
        const labels = rows.map(r => r.name);
        const data = rows.map(r => +(r.weight.toFixed(2)));
        const legendColor = getLegendColor();
        window._pie = new Chart(ctx, {
          type: 'pie',
          data: { labels, datasets: [{ data }] },
          options: {
            plugins: {
              legend: { position: 'bottom', labels: { color: legendColor } },
              tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.formattedValue}%` } }
            }
          }
        });
      }

      function animateAUM(target) {
        const el = document.getElementById('aumValue');
        const start = 0; const dur = 1000; const t0 = performance.now();
        function tick(t) {
          const p = Math.min(1, (t - t0) / dur);
          const v = start + (target - start) * p;
          el.textContent = fmtUSD0.format(v);
          if (p < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      async function main() {
        document.getElementById('year').textContent = new Date().getFullYear();
        const state = document.getElementById('sheetState');
        try {
          // AUM
          const aumCells = await fetchCSV(CONFIG.aumRange);
          const rawAum = aumCells?.[0]?.[0] ?? '';
          let aum = parseFloat(String(rawAum).replace(/[$,\s]/g,''));
          if (!Number.isFinite(aum)) throw new Error('AUM cell is not numeric');
          animateAUM(aum);

          // Last updated (optional)
          try {
            const upd = await fetchCSV(CONFIG.lastUpdatedRange);
            const text = upd?.[0]?.[0] || new Date().toISOString().slice(0,10);
            document.getElementById('lastUpdated').textContent = String(text);
          } catch { document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString(); }

          // Portfolio Table
          const rows = await fetchCSV(CONFIG.portfolioRange);
          const pairs = rows.map(r => [r[0], r[1]]);
          const normalized = normalizeWeights(pairs);
          renderTable(normalized);
          renderPie(normalized);
          state.textContent = 'Live';
          state.style.background = 'rgba(0,255,153,0.12)';
          state.style.color = '#6dffb8';
          state.style.borderColor = 'rgba(0,255,153,0.25)';
        } catch (err) {
          console.error(err);
          document.getElementById('aumError').hidden = false;
          document.getElementById('aumError').textContent = 'Could not load from Google Sheets. Check sharing permissions and the configured ranges in the code.';
          state.textContent = 'Offline';
          state.style.background = 'rgba(255,0,102,0.12)';
          state.style.color = '#ff99b0';
          state.style.borderColor = 'rgba(255,0,102,0.25)';
        }
      }

      main();
    </script>

    <!--
    HOW TO DEPLOY
    1) Put this single file (index.html) and your logo file (satssymbol.png) in a GitHub Pages repo or any static host.
    2) Make sure the Google Sheet is viewable to anyone with the link (or Publish to the web).
    3) Update CONFIG ranges to match your Dashboard tab:
       - aumRange       ‚Üí single cell containing numeric AUM (e.g., 'B2:B2')
       - lastUpdatedRange‚Üí optional date cell (e.g., 'B3:B3')
       - portfolioRange ‚Üí two columns: [Position, Weight] (e.g., 'A5:B50')
       - weightIsPercent‚Üí true if weights are 0‚Äì100, false if 0‚Äì1
    4) The pie and table will auto‚Äënormalize to 100%.
    -->
  </body>
</html>
